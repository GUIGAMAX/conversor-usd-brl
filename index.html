<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor USD ⇄ BRL (ao vivo)</title>
  <style>
    :root{--bg:#0b1220;--card:#10192d;--muted:#9fb3c8;--accent:#59d185;--danger:#ff6b6b}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:radial-gradient(1200px 800px at 10% 10%,#13203a 0%,#0b1220 60%),var(--bg);color:#e8f0ff;min-height:100svh;display:grid;place-items:center;padding:24px}
    .card{width:min(820px,95vw);background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{padding:22px 22px 8px}
    header h1{margin:0 0 6px;font-size:1.4rem}
    header p{margin:0;color:var(--muted);font-size:.95rem}
    .content{display:grid;gap:18px;padding:22px}
    .row{display:grid;gap:12px}
    @media(min-width:640px){.row{grid-template-columns:1fr auto 1fr;align-items:end}}
    label{display:block;font-size:.9rem;color:var(--muted);margin:0 0 6px}
    input[type="number"], input[readonly]{width:100%;padding:14px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1730;color:#e8f0ff;font-size:1.05rem;outline:none}
    input[type="number"]:focus{border-color:#5fa8ff;box-shadow:0 0 0 3px rgba(95,168,255,.2)}
    .swap{align-self:center;justify-self:center;border:none;background:transparent;color:#cfe1ff;font-size:1.6rem;cursor:pointer;line-height:1;padding:10px;border-radius:10px}
    .swap:hover{background:rgba(255,255,255,.06)}
    .rate{display:grid;gap:10px;align-items:center;grid-template-columns:1fr auto; padding:10px 12px;border-radius:12px;background:#0e1730;border:1px solid rgba(255,255,255,.08)}
    .rate small{color:var(--muted)}
    .pill{display:inline-flex;gap:8px;align-items:center;background:rgba(89,209,133,.12);border:1px solid rgba(89,209,133,.35);color:#c7ffd8;padding:8px 10px;border-radius:999px;font-size:.85rem}
    .pill.warn{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.35);color:#ffd1d1}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    select, button.primary, button.secondary{padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.18);background:#13224a;color:#e8f0ff;cursor:pointer}
    button.primary{background:var(--accent);color:#0b1220;border:none;font-weight:700}
    button.secondary{background:transparent}
    .out{padding:16px;border-radius:12px;background:#0e1730;border:1px solid rgba(255,255,255,.08);font-size:1.2rem}
    .error{color:var(--danger);font-size:.95rem}
    footer{padding:10px 22px 22px;color:var(--muted);font-size:.85rem;text-align:center}
  </style>
</head>
<body>
  <div class="card" role="region" aria-label="Conversor de moedas USD para BRL">
    <header>
      <h1>Conversor USD ⇄ BRL</h1>
      <p>Converta em tempo real com a cotação de mercado (atualiza automaticamente).</p>
    </header>

    <div class="content">
      <div class="rate" aria-live="polite">
        <div>
          <small>Taxa atual (1 USD → BRL):</small>
          <strong id="rate-display">—</strong>
          <span id="rate-side" class="pill" title="Tipo de preço">venda</span>
          <span id="rate-stale" class="pill warn" hidden>Sem conexão — usando taxa anterior</span>
          <div id="rate-meta" style="margin-top:6px; color:var(--muted); font-size:.85rem">Atualizado: —</div>
        </div>
        <div class="actions">
          <label for="side" style="color:var(--muted);font-size:.85rem">Preço:</label>
          <select id="side" title="Escolha entre preço de compra (bid) ou venda (ask)">
            <option value="ask">Venda (ask)</option>
            <option value="bid">Compra (bid)</option>
          </select>
          <button id="refresh" class="secondary" title="Atualizar agora">Atualizar</button>
          <button id="edit-rate" class="secondary" title="Definir taxa manual">Definir taxa</button>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="usd">Valor em USD</label>
          <input id="usd" type="number" step="0.01" min="0" placeholder="Ex.: 25.50" />
        </div>
        <button id="swap" class="swap" title="Inverter conversão" aria-label="Inverter">⇆</button>
        <div>
          <label for="brl">Resultado</label>
          <input id="brl" type="text" readonly class="out" placeholder="R$ 0,00" />
        </div>
      </div>

      <div class="error" id="error" role="alert" hidden></div>
      <button id="copy" class="primary">Copiar resultado</button>
    </div>

    <footer>
      <p>Fonte em tempo real: <code>economia.awesomeapi.com.br</code> (cotações USD/BRL com <em>bid/ask</em>).</p>
      <p>© 2025 — Desenvolvido por <strong>Guilherme Goulart</strong>.</p>
    </footer>
  </div>

<script>
alert('Conversor desenvolvido por Guilherme Goulart');
(function(){
  const $ = (sel) => document.querySelector(sel);
  const usd = $('#usd');
  const brl = $('#brl');
  const rateDisplay = $('#rate-display');
  const rateMeta = $('#rate-meta');
  const staleBadge = $('#rate-stale');
  const sideBadge = $('#rate-side');
  const errorBox = $('#error');
  const refreshBtn = $('#refresh');
  const editRateBtn = $('#edit-rate');
  const copyBtn = $('#copy');
  const swapBtn = $('#swap');
  const sideSelect = $('#side');

  const fmtBRL = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' });
  const fmtUSD = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

  let currentRate = parseFloat(localStorage.getItem('usd_brl_rate')) || 5.50; // fallback
  let inverted = false; // false: USD->BRL, true: BRL->USD

  // Restaurar preferência de lado (bid/ask)
  const savedSide = localStorage.getItem('usd_brl_side');
  if(savedSide){ sideSelect.value = savedSide; sideBadge.textContent = savedSide === 'bid' ? 'compra' : 'venda'; }

  function showRate(){
    rateDisplay.textContent = currentRate.toFixed(4);
  }

  function setStale(stale){
    staleBadge.hidden = !stale;
  }

  function updateMeta(ts){
    if(!ts){ rateMeta.textContent = 'Atualizado: —'; return; }
    const when = new Date(ts);
    rateMeta.textContent = `Atualizado: ${when.toLocaleString('pt-BR')}`;
  }

  async function fetchRate(){
    try{
      errorBox.hidden = true;
      const r = await fetch('https://economia.awesomeapi.com.br/json/last/USD-BRL',{cache:'no-store'});
      if(!r.ok) throw new Error('Falha ao buscar taxa');
      const data = await r.json();
      const p = data?.USDBRL;
      const side = sideSelect.value; // 'bid' (compra) ou 'ask' (venda)
      const raw = parseFloat(p?.[side]);
      if(Number.isFinite(raw) && raw > 0){
        currentRate = raw;
        localStorage.setItem('usd_brl_rate', String(currentRate));
        setStale(false);
        showRate();
        updateMeta(p?.create_date || Date.now());
        recalc();
      }else{
        throw new Error('Resposta inválida');
      }
    }catch(err){
      setStale(true);
      errorBox.textContent = 'Sem conexão ou serviço indisponível. Usando a última taxa salva.';
      errorBox.hidden = false;
      showRate();
    }
  }

  function recalc(){
    const val = parseFloat(String(usd.value).replace(',', '.'));
    if(Number.isFinite(val)){
      if(!inverted){
        const out = val * currentRate;
        brl.value = fmtBRL.format(out);
      }else{
        const out = val / currentRate;
        brl.value = fmtUSD.format(out);
      }
    }else{
      brl.value = '';
    }
  }

  function setManualRate(){
    const input = prompt('Informe a taxa desejada (1 USD em BRL):', currentRate.toFixed(4));
    if(input==null) return;
    const r = parseFloat(String(input).replace(',', '.'));
    if(!Number.isFinite(r) || r <= 0){
      alert('Valor inválido. Digite um número maior que 0.');
      return;
    }
    currentRate = r;
    localStorage.setItem('usd_brl_rate', String(currentRate));
    setStale(true);
    updateMeta(null);
    showRate();
    recalc();
  }

  function swap(){
    inverted = !inverted;
    const leftLabel = document.querySelector('label[for="usd"]');
    const rightLabel = document.querySelector('label[for="brl"]');

    if(inverted){
      leftLabel.textContent = 'Valor em BRL';
      rightLabel.textContent = 'Resultado';
      usd.placeholder = 'Ex.: 100,00';
      brl.placeholder = '$ 0.00';
      recalc();
    }else{
      leftLabel.textContent = 'Valor em USD';
      rightLabel.textContent = 'Resultado';
      usd.placeholder = 'Ex.: 25.50';
      brl.placeholder = 'R$ 0,00';
      recalc();
    }
  }

  usd.addEventListener('input', recalc);
  refreshBtn.addEventListener('click', fetchRate);
  editRateBtn.addEventListener('click', setManualRate);
  copyBtn.addEventListener('click', async () => {
    if(!brl.value){
      errorBox.textContent = 'Nada para copiar ainda.';
      errorBox.hidden = false;
      return;
    }
    try{
      await navigator.clipboard.writeText(brl.value);
      copyBtn.textContent = 'Copiado!';
      setTimeout(()=> copyBtn.textContent = 'Copiar resultado', 1200);
    }catch{
      errorBox.textContent = 'Não foi possível copiar automaticamente.';
      errorBox.hidden = false;
    }
  });
  swapBtn.addEventListener('click', swap);
  sideSelect.addEventListener('change', () => {
    localStorage.setItem('usd_brl_side', sideSelect.value);
    sideBadge.textContent = sideSelect.value === 'bid' ? 'compra' : 'venda';
    fetchRate();
  });

  setInterval(fetchRate, 30000);
  showRate();
  fetchRate();
})();
</script>
</body>
</html>
